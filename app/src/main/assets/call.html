<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
        }
        #video-grid {
            display: flex;
            flex-wrap: wrap;
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        video {
            object-fit: cover;
        }
        #remote-video {
            width: 100%;
            height: 100%;
            position: absolute;
        }
        #local-video {
            width: 120px;
            height: 160px;
            position: absolute;
            bottom: 16px;
            right: 16px;
            border-radius: 8px;
            border: 2px solid white;
            z-index: 100;
        }
        #status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<div id="video-grid">
    <video id="remote-video" autoplay playsinline></video>
    <video id="local-video" autoplay playsinline muted></video>
</div>
<div id="status">Bağlanıyor...</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>

<script>
    let peer;
    let localStream;
    let remoteStream;
    let currentPeerId = '';

    // Android ile iletişim fonksiyonları
    window.toggleAudio = function(isEnabled) {
        console.log('Toggle audio: ' + isEnabled);
        if (localStream) {
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                audioTracks[0].enabled = isEnabled;
                console.log('Audio track enabled: ' + audioTracks[0].enabled);

                // Android'e durumu bildir
                try {
                    Android.onAudioStateChanged(isEnabled);
                } catch (e) {
                    console.log('Android interface not available');
                }
            }
        }
    }

    window.toggleVideo = function(isEnabled) {
        console.log('Toggle video: ' + isEnabled);
        if (localStream) {
            const videoTracks = localStream.getVideoTracks();
            if (videoTracks.length > 0) {
                videoTracks[0].enabled = isEnabled;
                console.log('Video track enabled: ' + videoTracks[0].enabled);

                // Android'e durumu bildir
                try {
                    Android.onVideoStateChanged(isEnabled);
                } catch (e) {
                    console.log('Android interface not available');
                }
            }
        }
    }

    window.endCall = function() {
        console.log('Ending call...');
        if (peer) {
            peer.destroy();
        }
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        document.getElementById('status').innerText = 'Çağrı sonlandırıldı';
    }

    window.init = function(peerId) {
        console.log('Initializing with ID: ' + peerId);
        currentPeerId = peerId;
        initializePeer(peerId);
    }

    window.startCall = function(remotePeerId) {
        console.log('Starting call to: ' + remotePeerId);
        makeCall(remotePeerId);
    }

    async function initializePeer(peerId) {
        try {
            document.getElementById('status').innerText = 'Kamera ve mikrofona erişiliyor...';

            // Kamera ve mikrofon erişimi
            localStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });

            document.getElementById('local-video').srcObject = localStream;
            document.getElementById('status').innerText = 'Bağlantı kuruluyor...';

            // PeerJS bağlantısı
            peer = new Peer(peerId, {
                debug: 3,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', function(id) {
                console.log('Peer connected with ID: ', id);
                document.getElementById('status').innerText = 'Bağlantı hazır: ' + id;
                // Android tarafına bağlantının hazır olduğunu bildir
                Android.onPeerConnected();
            });

            peer.on('call', function(call) {
                console.log('Incoming call from: ', call.peer);
                document.getElementById('status').innerText = 'Gelen çağrı...';

                call.answer(localStream);

                call.on('stream', function(stream) {
                    console.log('Remote stream received');
                    document.getElementById('status').style.display = 'none';
                    remoteStream = stream;
                    document.getElementById('remote-video').srcObject = stream;
                });

                call.on('error', function(err) {
                    console.error('Call error: ', err);
                    document.getElementById('status').innerText = 'Çağrı hatası: ' + err;
                });
            });

            peer.on('error', function(err) {
                console.error('Peer error: ', err);
                document.getElementById('status').innerText = 'Hata: ' + err.type;
            });

            peer.on('close', function() {
                console.log('Peer connection closed');
                document.getElementById('status').innerText = 'Bağlantı kapatıldı';
            });

        } catch (error) {
            console.error('Error initializing: ', error);
            document.getElementById('status').innerText = 'Hata: ' + error.message;
            Android.showToast('Hata: ' + error.message);
        }
    }

    function makeCall(remotePeerId) {
        console.log('Making call to: ', remotePeerId);
        document.getElementById('status').innerText = 'Arama yapılıyor...';

        if (!peer || !localStream) {
            console.error('Peer or local stream not ready');
            document.getElementById('status').innerText = 'Bağlantı hazır değil';
            return;
        }

        const call = peer.call(remotePeerId, localStream);

        call.on('stream', function(stream) {
            console.log('Call stream received');
            document.getElementById('status').style.display = 'none';
            remoteStream = stream;
            document.getElementById('remote-video').srcObject = stream;
        });

        call.on('close', function() {
            console.log('Call closed');
            document.getElementById('status').innerText = 'Çağrı sonlandı';
        });

        call.on('error', function(err) {
            console.error('Call error: ', err);
            document.getElementById('status').innerText = 'Arama hatası: ' + err;
        });
    }

    // Hata ayıklama için global erişim
    window.getPeer = function() { return peer; };
    window.getLocalStream = function() { return localStream; };
    window.getRemoteStream = function() { return remoteStream; };

</script>
</body>
</html>